# Тестирование разработанного модуля
Разработка модуля характеризуется не только написанием модуля, описывающего принцип его работы, но и необходимостью доказать его работоспособность.
Работоспособность модуля можно доказать подавая на входы различные значения с последующим получением ожидаемого результата на выходах. В **SystemVerilog** для
базового тестирования модуля используются **тестбенч (testbench)** — это модуль, написанный на SystemVerilog, который не предназначен для синтеза (не превращается в схему). 
Его единственная цель — проверить функциональность синтезируемого модуля (DUT). Данный гайд несет в себе цель научить вас писать простейшие тесты. Проверять работоспособность своего модуля
с помощью тестов гораздо рациональнее хотя бы потому, что вам не приходится ждать по N минут момента, когда сгенерируется битстрим и вы увидите результат на плате. Помимо того, если ваш модуль
отработал неправильно, плата не скажет в каком месте возникла ошибка, а тестбенч (при должном его написании) - скажет.

## Структура гайда
1. [Создание testbench в Vivado](#Создание-testbench-в-Vivado)
2. [Привязка модуля к тестбенчу](#Привязка-модуля-к-тестбенчу)
3. [Запуск симуляции](#Запуск-симуляции)
4. [Initial block](#Initial-block)

## Создание testbench в Vivado
Представим, что у нас есть спроектированный модуль, который необходимо отверифицировать:
![](../img/main_module.jpg)

Для того, чтобы начать процесс создания тестбенча, необходимо правой кнопкой кликнуть по **Simulation Sources**, а затем кликнуть на **Add Sources...**:

![](../img/add_tb1.jpg)

После этого откроется меню, в котором необходимо выбрать **Add or create simulation sources** и затем кликнуть **Next**:

![](../img/add_tb2.jpg)

Далее откроется меню _Add or create simulation sources_, в нем выбираем **Create File** в случае, если нужно создать тестбенч, и **Add Files**, если тестбенч уже есть и его нужно просто добавить в проект:

![](../img/create_tb1.jpg)

В случае выбора _Create File_, появится меню, в котором необходимо будет указать **File Type** и **File Name**. 
* Тип файла **SystemVerilog**.
* Имя файла можно указывать любым. Однако хорошей практикой считается имя, которое содержит в себе название тестируемого модуля с припиской **_tb**.
* Указав настройки выше, кликаем **OK**.

![](../img/create_tb2.jpg)

В окне, выделенном красным, появится информация о созданном/добавленном файле. Убедившись в том, что все необходимое создалось/добавилось, жмем **Finish**.

![](../img/create_tb3.jpg)

Появится еще одно окно, в котором кликаем **OK**

![](../img/create_tb4.jpg)

В следующем окне кликаем **Yes**

![](../img/create_tb5.jpg)

В результате в разделе **Simulation Sources/sim_1** появится созданный тестбенч

![](../img/set_top_tb1.jpg)

Однако только создать его недостаточно, его также необходимо назначить модулем верхнего уровня.
* Правой кнопкой кликаем по тестбенчу
* Выбираем опцию **Set as Top**

![](../img/set_top_tb2.jpg)

После выполнения всех шагов выше, создания модуля для тестирования можно считать завершенным.

## Привязка модуля к тестбенчу
Успешно создав модуль для тестирования, необходимо его привязать к модулю, работоспособность которого требуется проверить. Вы наверняка уже этим занимались, поэтому искренне надеюсь, что данный
процесс ни у кого не вызовет никаких вопросов. Ниже приведен пример привязки:

```verilog
module adder_tb();

logic[31:0] op1;
logic[31:0] op2;

logic[31:0] ans;

adder DUT(
  .a_i ( op1 ),
  .b_i ( op2 ),
  .c_o ( ans )
);
```

Из примера можно выделить следующее:
* В тестбенче **НЕ СОЗДАЮТСЯ** входы и выходы. Создаются только внутренние сигналы, которые затем подвязываются к входам и выходам тестируемого модуля.
* Чтобы полностью проверить работоспособность модуля, для каждого его входа нужно создать сигнал, который будет к нему привязан.
* В целом для выходов тестируемого модуля необязательно создавать сигналы в тестбенче, которые к этим выходам будут привязаны. Информацию о состоянии
выхода все равно можно будет получить. Как ее получить будет рассказано в следующем разделе.

## Запуск симуляции
Первым делом перед запуском симуляции убеждаемся в том, что в **Design Sources** и **Simulation Sources** в качестве модулей верхнего уровня выбраны правильные модули:

![](../img/check_tb.jpg)

Убедившись в этом, в **Flow Navigator** ищем **Simulation** и жмем на **Run Simulation**. В меню выбора кликаем на **Run Behavioral Simulation**:

![](../img/run_sim_tb.jpg)

В результате откроется пугающее окно с множественным функционалом, который ниже будет разобран:

![](../img/sim_info_tb1.jpg)

1. **Scope** - здесь указана иерархия модулей. Самым высоким модулем по иерархии является тестбенч. Тестируемый модуль **ВСЕГДА** находится по иерархии ниже, чем тестбенч.
2. **Objects** - здесь представлена информация о том, какие сигналы содержатся в выделенном в **Scope** модуле. На данном скриншоте мы видим сигналы из **adder_tb** т.к. именно он выделен
в **Scope**. Если выделить **DUT**, то в **Objects** будут представлены сигналы из тестируемого модуля.
3. **Waveform** - временная диаграмма, на которой будет представлена информация о том, в каком состоянии находятся входные сигналы и какое значение приняли выходные сигналы. Пока что она пустая
по причине того, что туда попросту еще ничего не было добавлено.

На скриншотах ниже представлен процесс изменения **Objects** в зависимости от того, какой модуль в **Scope** был выбран:

![](../img/sim_info_tb2.jpg)

![](../img/sim_info_tb3.jpg)

Теперь поговорим о том, как добавляются сигналы на временную диаграмму:

![](../img/wave_tb1.jpg)

Из скриншота нужно усвоить следующее:
* В **Scope** выбирается модуль, сигналы которого необходимо добавить на временную диаграмму.
* В **Objects** по нужному сигналу кликаем правой кнопкой мыши и выбираем **Add to Wave Window**.
* Если требуется изменить систему счисления для сигнала, то выбираем в **Radix** ту, которая нужна. Тогда в поле **Value**
значение сигнала будет отображаться в той системе, которая была выбрана, **НО** на временной диаграмме еще нет. О том, как
установить нужную систему счисления на временной диаграмме, будет рассказано ниже.

После этого на **Waveform (временной диаграмме)** появятся сигналы, которые вы добавили, а также будут отображаться значения входов и выходов тестируемого модуля:

![](../img/wave_tb2.jpg)

Обратим внимание на следующее:
* Если требуется изменить систему счисления, то также правой кнопкой кликаем по сигналу и в **Radix** меняем ее.
* Т.к. пока не было подано никаких входных воздействий на спроектированное устройство, входы и выходы находятся
в **неизвестном состоянии X**.

На предыдущем скриншоте на временную диаграмму были добавлены сигналы из модуля **adder_tb**, вам ничего не мешает сделать то же самое и для тестируемого модуля **DUT**:

![](../img/wave_tb3.jpg)

Далее будет затронута тема того, как же подать входные воздействия на устройство и как определять правильность работы тестируемого модуля по временной диаграмме.

## Initial block
